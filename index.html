<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secret Santa - 3 Word IDs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #d32f2f;       /* Santa Red */
      --secondary: #1b5e20;     /* Pine Green */
      --card-bg: rgba(255, 255, 255, 0.95);
      --text-main: #2c3e50;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Quicksand", sans-serif;
      min-height: 100vh;
      color: var(--text-main);
      background: radial-gradient(circle at 50% 0%, #1e3a8a 0%, #0f172a 100%);
      overflow-x: hidden;
    }

    /* --- CANVAS SNOW LAYER --- */
    #snow-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    /* --- LAYOUT --- */
    .container {
      position: relative;
      z-index: 1;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    h1 {
      text-align: center;
      color: #fff;
      font-size: 2.5rem;
      margin-bottom: 2rem;
      text-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    h1 span { display: inline-block; animation: float 3s ease-in-out infinite; }
    
    h2 {
      margin-top: 0;
      color: var(--secondary);
      font-size: 1.4rem;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255,255,255,0.3);
      backdrop-filter: blur(10px);
    }

    label {
      display: block;
      margin-top: 1rem;
      font-weight: 700;
      font-size: 0.9rem;
      color: #4a5568;
      margin-bottom: 0.3rem;
    }

    input[type="text"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: 0.8rem 1rem;
      border-radius: 8px;
      border: 2px solid #cbd5e1;
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.2s;
      background: #f8fafc;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--secondary);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.5;
    }

    /* Password Input Wrapper */
    .password-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    .password-wrapper input { padding-right: 40px; }
    .toggle-password {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0;
      margin: 0;
      color: #64748b;
      box-shadow: none !important;
      transform: none !important;
    }
    .toggle-password:hover { color: var(--secondary); }

    button {
      background: linear-gradient(135deg, var(--secondary), #2e7d32);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 1.5rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
      transition: transform 0.1s;
    }
    button:hover:not(:disabled) { transform: translateY(-2px); }
    button:disabled { background: #94a3b8; cursor: not-allowed; }
    
    button.secondary { background: linear-gradient(135deg, #475569, #334155); }
    button.copy-btn { 
        padding: 0.4rem 0.8rem; 
        font-size: 0.85rem; 
        margin-top: 0;
        background: #f1f5f9;
        color: #334155;
        border: 1px solid #cbd5e1;
        box-shadow: none;
    }
    button.copy-btn:hover { background: #e2e8f0; transform: translateY(-1px); }

    .hidden { display: none; }
    .small { font-size: 0.9rem; color: #64748b; margin-top: 0.5rem; line-height: 1.4; }
    .error { color: #d32f2f; font-weight: bold; }
    .success { color: #2e7d32; font-weight: bold; }

    /* Tables */
    .table-responsive {
      overflow-x: auto;
      margin-top: 1rem;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { text-align: left; padding: 0.75rem 1rem; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
    th { background: #f1f5f9; color: #334155; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; }
    
    .access-code {
        font-family: monospace;
        font-weight: bold;
        color: var(--primary);
        font-size: 1.1em;
        letter-spacing: 1px;
    }

    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
  </style>
</head>
<body>

  <canvas id="snow-canvas"></canvas>

  <div class="container">
    <h1><span>üéÖ</span> Secret Santa</h1>

    <div id="setup-card" class="card">
      <h2>1. Create Event</h2>
      <p class="small">Enter names to generate a unique code for each person.</p>
      
      <label>Master Password (for Organiser only)</label>
      <div class="password-wrapper">
        <input id="masterPassword" type="password" placeholder="Choose a secure password" />
        <button type="button" class="toggle-password" onclick="togglePasswordVisibility('masterPassword')">üëÅÔ∏è</button>
      </div>

      <label>Participants</label>
      <p class="small" style="margin-top:0;">One name per line (e.g., "Alice", "Bob")</p>
      <textarea id="participants" placeholder="Alice
Bob
Charlie"></textarea>

      <button id="createEventBtn">üéÅ Create & Shuffle</button>
      <div id="setupMessage" class="small"></div>
    </div>

    <div id="admin-card" class="card hidden">
      <h2>Organiser Dashboard</h2>
      <p class="small">
        <strong>Event Created!</strong> Share the <strong>Event ID</strong> with the group. 
        Then, privately send each person their <strong>Access Code</strong>.
      </p>

      <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border: 1px solid #bbf7d0; margin-bottom: 1.5rem;">
        <strong>Event ID:</strong> <span id="displayEventId" style="font-weight:bold; color:#15803d; font-size:1.2em;"></span>
      </div>

      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Access Code</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="adminTableBody"></tbody>
        </table>
      </div>
      
      <p class="small" style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
        To view this later, refresh and use "Admin Login".
      </p>
    </div>

    <div id="participant-card" class="card">
      <h2>Participant Zone</h2>
      <p class="small">Enter the Event ID and your unique Access Code to see who you got!</p>

      <label>Event ID</label>
      <input id="eventIdInput" type="text" placeholder="e.g. jolly-red-santa" />

      <label>Your Access Code</label>
      <input id="accessCodeInput" type="text" placeholder="e.g. X8D9S7" />

      <button id="viewRecipientBtn">üîç Reveal Recipient</button>
      <div id="participantResult" class="small" style="margin-top: 1rem; font-size: 1.1rem;"></div>
    </div>

    <div id="admin-login-card" class="card">
      <h2>Admin Login</h2>
      <p class="small">Organiser: Login to view codes and status.</p>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <div style="flex:1; min-width: 150px;">
            <input id="adminEventIdInput" type="text" placeholder="Event ID" />
        </div>
        <div style="flex:1; min-width: 150px;">
             <div class="password-wrapper">
              <input id="adminPassInput" type="password" placeholder="Master Password" />
              <button type="button" class="toggle-password" onclick="togglePasswordVisibility('adminPassInput')">üëÅÔ∏è</button>
            </div>
        </div>
      </div>
      
      <button id="loadAdminBtn" class="secondary">üîì View Codes</button>
      <div id="adminMessage" class="small"></div>
    </div>

  </div>

  <script>
    (function() {
      const canvas = document.getElementById('snow-canvas');
      const ctx = canvas.getContext('2d');
      let w, h, flakes = [];
      const resize = () => { w=canvas.width=innerWidth; h=canvas.height=innerHeight; };
      window.addEventListener('resize', resize);
      resize();

      class Flake {
        constructor() { this.init(true); }
        init(first) {
          this.x = Math.random() * w; this.y = first ? Math.random()*h : -10;
          this.r = Math.random()*2+1; this.s = Math.random()*1+0.5; this.d = Math.random()*w;
        }
        update() {
          this.y += this.s; this.x += Math.sin(this.d)*0.5; this.d+=0.01;
          if(this.y>h) this.init(false);
        }
        draw() { ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.6)'; ctx.fill(); }
      }
      for(let i=0; i<80; i++) flakes.push(new Flake());
      function loop() { ctx.clearRect(0,0,w,h); flakes.forEach(f=>{f.update();f.draw()}); requestAnimationFrame(loop); }
      loop();
    })();

    window.togglePasswordVisibility = function(id) {
        const input = document.getElementById(id);
        input.type = input.type === "password" ? "text" : "password";
    }
  </script>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyAdevrXnZ-rfHNxXHHh-R9_aDEKzqeU1mQ",
      authDomain: "secret-santa-organiser.firebaseapp.com",
      projectId: "secret-santa-organiser",
      storageBucket: "secret-santa-organiser.firebasestorage.app",
      messagingSenderId: "851546467900",
      appId: "1:851546467900:web:e81ee0bc4d6790bffa9d39"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Helpers ---
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function generateDerangement(items) {
      if (items.length < 2) return null;
      let shuffled, attempts = 0;
      do {
        shuffled = shuffle([...items]);
        attempts++;
        if (attempts > 1000) return null;
      } while (items.some((x, i) => x === shuffled[i]));
      const res = {};
      items.forEach((giver, i) => res[giver] = shuffled[i]);
      return res;
    }

    function normalize(str) { return str.toLowerCase().replace(/[^a-z0-9]/g, ''); }

    function generateCode() {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let result = "";
      for (let i = 0; i < 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function generateChristmasId() {
        const mood = [
            "jolly", "merry", "happy", "lucky", "magic", "sweet", "festive", 
            "brave", "super", "best", "cozy", "warm", "bouncy"
        ];
        const quality = [
            "red", "green", "gold", "silver", "white", "snowy", "frosty", 
            "shiny", "fuzzy", "glowing", "sparkly", "tiny", "flying", "winter"
        ];
        const noun = [
            "santa", "elf", "reindeer", "snowman", "gift", "star", "tree", 
            "bell", "sleigh", "candy", "cookie", "cake", "pudding", "turkey", 
            "robin", "wreath", "holly", "ivy", "bauble", "tinsel", "flake"
        ];
        
        const m = mood[Math.floor(Math.random() * mood.length)];
        const q = quality[Math.floor(Math.random() * quality.length)];
        const n = noun[Math.floor(Math.random() * noun.length)];
        
        return `${m}-${q}-${n}`;
    }

    async function createEvent() {
      const masterPass = document.getElementById("masterPassword").value.trim();
      const rawText = document.getElementById("participants").value;
      const msg = document.getElementById("setupMessage");

      msg.textContent = ""; msg.className = "small";

      if (!masterPass) { msg.textContent = "Please set a Master Password."; msg.className = "error"; return; }

      const names = rawText.split("\n").map(l => l.trim()).filter(Boolean);
      const uniqueNames = [...new Set(names)];
      
      if (uniqueNames.length < 3) { msg.textContent = "Need at least 3 participants."; msg.className = "error"; return; }

      const mapping = generateDerangement(uniqueNames);
      if (!mapping) { msg.textContent = "Shuffle failed. Try again."; msg.className = "error"; return; }

      const eventId = generateChristmasId(); // 3-Word ID
      const participantsData = {};

      uniqueNames.forEach(name => {
        const key = normalize(name);
        participantsData[key] = {
          name: name,
          recipientName: mapping[name],
          accessCode: generateCode(),
          viewed: false
        };
      });

      try {
        const btn = document.getElementById("createEventBtn");
        btn.disabled = true; btn.textContent = "Shuffling...";
        
        await setDoc(doc(db, "secret_santa_events", eventId), {
          masterPassword: masterPass,
          createdAt: new Date().toISOString(),
          participants: participantsData
        });

        document.getElementById("setup-card").classList.add("hidden");
        document.getElementById("admin-card").classList.remove("hidden");
        document.getElementById("displayEventId").textContent = eventId;
        
        renderAdminTable(participantsData);
        
        // Auto-fill inputs
        document.getElementById("eventIdInput").value = eventId;
        document.getElementById("adminEventIdInput").value = eventId;
        document.getElementById("adminPassInput").value = masterPass;

      } catch (e) {
        console.error(e);
        msg.textContent = "Error: " + e.message;
        btn.disabled = false;
        btn.textContent = "üéÅ Create & Shuffle";
      }
    }

    function renderAdminTable(participantsData) {
        const tbody = document.getElementById("adminTableBody");
        tbody.innerHTML = "";
        const sortedKeys = Object.keys(participantsData).sort((a,b) => participantsData[a].name.localeCompare(participantsData[b].name));

        sortedKeys.forEach(key => {
          const p = participantsData[key];
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><strong>${p.name}</strong></td>
            <td>
                <span class="access-code">${p.accessCode}</span>
                <button class="copy-btn" onclick="navigator.clipboard.writeText('${p.accessCode}'); alert('Copied code for ${p.name}')">üìã</button>
            </td>
            <td>${p.viewed ? "‚úÖ Viewed" : "<span style='color:#ccc'>Waiting</span>"}</td>
          `;
          tbody.appendChild(tr);
        });
    }

    async function viewRecipient() {
      const eventId = document.getElementById("eventIdInput").value.trim().toLowerCase();
      const code = document.getElementById("accessCodeInput").value.trim().toUpperCase();
      const resEl = document.getElementById("participantResult");

      resEl.innerHTML = ""; resEl.className = "small";

      if (!eventId || !code) { resEl.textContent = "Event ID and Access Code required."; resEl.className = "error"; return; }

      try {
        const docRef = doc(db, "secret_santa_events", eventId);
        const snap = await getDoc(docRef);
        
        if (!snap.exists()) { resEl.textContent = "Event ID not found (check spelling!)."; resEl.className = "error"; return; }
        
        const data = snap.data();
        const participants = data.participants || {};
        
        // FIND PARTICIPANT BY CODE
        let me = null;
        let myKey = null;

        for (const [key, p] of Object.entries(participants)) {
            if (p.accessCode === code) {
                me = p;
                myKey = key;
                break;
            }
        }

        if (!me) {
          resEl.textContent = "‚ùå Invalid Access Code.";
          resEl.className = "error";
          return;
        }

        // SHOW RESULT IMMEDIATELY
        resEl.innerHTML = `
          <div style="background:#e8f5e9; padding:1.5rem; border-radius:8px; border:2px solid #2e7d32; text-align:center;">
            Hi <strong>${me.name}</strong>! You are buying for:<br>
            <h2 style="font-size:2rem; margin:15px 0; color:#1b5e20;">${me.recipientName}</h2>
          </div>
        `;

        // UPDATE DB SILENTLY
        if (!me.viewed) {
          try {
            const newData = { ...data };
            newData.participants[myKey].viewed = true;
            await setDoc(docRef, newData); 
          } catch (writeErr) {
            console.warn("Viewed status save failed (permission issue). User still saw result.", writeErr);
          }
        }

      } catch (e) {
        console.error(e);
        resEl.textContent = "Error: " + e.message; resEl.className = "error";
      }
    }

    async function loadAdmin() {
      const eventId = document.getElementById("adminEventIdInput").value.trim().toLowerCase();
      const pass = document.getElementById("adminPassInput").value.trim();
      const msg = document.getElementById("adminMessage");
      const adminCard = document.getElementById("admin-card");

      msg.textContent = ""; msg.className = "small";
      adminCard.classList.add("hidden");

      if (!eventId || !pass) { msg.textContent = "Enter Event ID and Password."; msg.className = "error"; return; }

      try {
        const snap = await getDoc(doc(db, "secret_santa_events", eventId));
        if (!snap.exists()) { msg.textContent = "Event Not Found"; msg.className = "error"; return; }
        const data = snap.data();
        
        if (data.masterPassword !== pass) {
          msg.textContent = "Wrong Password."; msg.className = "error"; return;
        }

        adminCard.classList.remove("hidden");
        document.getElementById("displayEventId").textContent = eventId;
        renderAdminTable(data.participants);
        adminCard.scrollIntoView({ behavior: 'smooth' });
        
      } catch (e) { console.error(e); msg.textContent = "Error: " + e.message; }
    }

    document.getElementById("createEventBtn").addEventListener("click", createEvent);
    document.getElementById("viewRecipientBtn").addEventListener("click", viewRecipient);
    document.getElementById("loadAdminBtn").addEventListener("click", loadAdmin);

  </script>
</body>
</html>