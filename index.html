<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secret Santa Organiser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #d32f2f;       /* Santa Red */
      --secondary: #1b5e20;     /* Pine Green */
      --accent: #ffb300;        /* Gold */
      --bg-gradient-start: #0f172a;
      --bg-gradient-end: #1e293b;
      --card-bg: rgba(255, 255, 255, 0.95);
      --text-main: #2c3e50;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Quicksand", sans-serif;
      min-height: 100vh;
      color: var(--text-main);
      background: radial-gradient(circle at 50% 0%, #1e3a8a 0%, #0f172a 100%);
      overflow-x: hidden;
    }

    /* --- CANVAS SNOW LAYER --- */
    #snow-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    /* --- LAYOUT --- */
    .container {
      position: relative;
      z-index: 1; /* Above snow */
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    h1 {
      text-align: center;
      color: #fff;
      font-size: 2.5rem;
      margin-bottom: 2rem;
      text-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    h1 span { display: inline-block; animation: float 3s ease-in-out infinite; }
    
    h2 {
      margin-top: 0;
      color: var(--secondary);
      font-size: 1.4rem;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }

    h3 { margin: 0 0 0.5rem 0; color: var(--primary); }

    /* --- CARDS --- */
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 
        0 20px 25px -5px rgba(0, 0, 0, 0.2), 
        0 8px 10px -6px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255,255,255,0.3);
      backdrop-filter: blur(10px);
      transition: transform 0.2s ease;
    }

    /* --- FORMS & INPUTS --- */
    label {
      display: block;
      margin-top: 1rem;
      font-weight: 700;
      font-size: 0.9rem;
      color: #4a5568;
      margin-bottom: 0.3rem;
    }

    input[type="text"],
    input[type="email"],
    textarea {
      width: 100%;
      padding: 0.8rem 1rem;
      border-radius: 8px;
      border: 2px solid #cbd5e1;
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.2s;
      background: #f8fafc;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--secondary);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.5;
    }

    /* Checkbox Styling */
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 1.2rem;
      height: 1.2rem;
      accent-color: var(--secondary);
      cursor: pointer;
    }
    .checkbox-wrapper label {
      margin: 0; /* Override default label margin */
      cursor: pointer;
    }

    /* --- BUTTONS --- */
    button {
      background: linear-gradient(135deg, var(--secondary), #2e7d32);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 1.5rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
      transition: transform 0.1s, box-shadow 0.1s;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
    }

    /* --- UTILS --- */
    .hidden { display: none; }
    
    .small {
      font-size: 0.9rem;
      color: #64748b;
      margin-top: 0.5rem;
      line-height: 1.4;
    }
    
    .error { color: #d32f2f; font-weight: bold; }
    .success { color: #2e7d32; font-weight: bold; }

    code {
      background: #e2e8f0;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: monospace;
      color: #c02525;
      font-weight: bold;
    }

    /* --- TABLES --- */
    .table-responsive {
      overflow-x: auto;
      margin-top: 1rem;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    
    th, td {
      text-align: left;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.9rem;
    }
    
    th {
      background: #f1f5f9;
      color: #334155;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }

    tr:last-child td { border-bottom: none; }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    @media (max-width: 600px) {
      h1 { font-size: 1.8rem; flex-direction: column; }
      .card { padding: 1.5rem; }
    }
  </style>
</head>
<body>

  <canvas id="snow-canvas"></canvas>

  <div class="container">
    <h1><span>üéÑ</span> Secret Santa Organiser</h1>

    <div id="setup-card" class="card">
      <h2>1. Create Event</h2>
      <p class="small">Fill this in once to set up the game. üéÖ</p>
      
      <label for="organiserName">Organiser Name</label>
      <input id="organiserName" type="text" placeholder="e.g. Santa Claus" />

      <label for="organiserEmail">Organiser Email</label>
      <input id="organiserEmail" type="email" placeholder="e.g. santa@northpole.com" />

      <label for="participants">Participants</label>
      <p class="small" style="margin-top:0;">Enter one per line. Format: <code>Name</code> or <code>Name &lt;email&gt;</code></p>
      <textarea id="participants" placeholder="Rudolph <rednose@example.com>
Dasher
Dancer <dancer@example.com>"></textarea>

      <div class="checkbox-wrapper">
        <input type="checkbox" id="includeOrganiser" />
        <label for="includeOrganiser">Include organiser as a participant</label>
      </div>

      <button id="createEventBtn">üéÅ Create Event</button>
      <div id="setupMessage" class="small"></div>
    </div>

    <div id="share-card" class="card hidden">
      <h2>2. Share with Participants</h2>
      <p class="small">Send this link to your group. They will use their name or email to unlock their assignment.</p>
      
      <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border: 1px solid #bbf7d0;">
        <strong>Event Link:</strong><br>
        <code id="eventLink" style="word-break: break-all; background: none; padding: 0; color: #15803d;"></code>
      </div>
      
      <p class="small">Admin Email: <strong id="adminEmailDisplay"></strong></p>
    </div>

    <div id="participant-card" class="card">
      <h2>Participant Zone</h2>
      <p class="small">Find out who you are gifting! üéÅ</p>

      <label for="eventIdInput">Event ID</label>
      <input id="eventIdInput" type="text" placeholder="Auto-filled from link" />

      <label for="participantKeyInput">Your Name or Email</label>
      <input id="participantKeyInput" type="text" placeholder="Enter exactly as signed up" />

      <button id="viewRecipientBtn">üîç Reveal Recipient</button>

      <div id="participantResult" class="small" style="margin-top: 1rem; font-size: 1.1rem;"></div>
    </div>

    <div id="admin-card" class="card">
      <h2>Organiser Dashboard</h2>
      <p class="small">Check who has viewed their assignment.</p>

      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <div style="flex: 1;">
          <label for="adminEventIdInput">Event ID</label>
          <input id="adminEventIdInput" type="text" />
        </div>
        <div style="flex: 1;">
          <label for="adminEmailInput">Organiser Email</label>
          <input id="adminEmailInput" type="email" />
        </div>
      </div>

      <button id="loadAdminBtn" class="secondary">üìã Load Stats</button>
      <div id="adminMessage" class="small"></div>
      
      <div id="adminTableWrapper" class="hidden">
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Participant</th>
                <th>Target</th>
                <th>Seen?</th>
              </tr>
            </thead>
            <tbody id="adminTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const canvas = document.getElementById('snow-canvas');
      const ctx = canvas.getContext('2d');
      let width, height;
      let flakes = [];

      function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
      }

      class Flake {
        constructor() {
          this.init(true);
        }

        init(firstRun = false) {
          this.x = Math.random() * width;
          // If first run, scatter everywhere. If recycle, start at top
          this.y = firstRun ? Math.random() * height : -10;
          this.r = Math.random() * 2 + 1; // Radius
          this.d = Math.random() * width; // Density/Sway seed
          this.s = Math.random() * 1 + 0.5; // Speed
          this.a = Math.random() * 0.5 + 0.4; // Opacity
        }

        update() {
          this.y += this.s;
          // Sway movement
          this.x += Math.sin(this.d) * 0.5;
          this.d += 0.01;

          if (this.y > height) {
            this.init(false);
          }
        }

        draw() {
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255, 255, 255, ${this.a})`;
          ctx.fill();
        }
      }

      function initSnow() {
        resize();
        flakes = [];
        // Create 100 flakes
        for (let i = 0; i < 100; i++) {
          flakes.push(new Flake());
        }
        loop();
      }

      function loop() {
        ctx.clearRect(0, 0, width, height);
        for (let flake of flakes) {
          flake.update();
          flake.draw();
        }
        requestAnimationFrame(loop);
      }

      window.addEventListener('resize', resize);
      initSnow();
    })();
  </script>

  <script type="module">
    // TODO: replace this config with your own Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAdevrXnZ-rfHNxXHHh-R9_aDEKzqeU1mQ",
      authDomain: "secret-santa-organiser.firebaseapp.com",
      projectId: "secret-santa-organiser",
      storageBucket: "secret-santa-organiser.firebasestorage.app",
      messagingSenderId: "851546467900",
      appId: "1:851546467900:web:e81ee0bc4d6790bffa9d39",
      measurementId: "G-ZBJW29F5PJ"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Logic Helpers ---
    function shuffle(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function generateDerangement(items) {
      if (items.length < 2) return null;
      let shuffled;
      let attempts = 0;
      do {
        shuffled = shuffle(items);
        attempts++;
        if (attempts > 1000) return null;
      } while (items.some((x, i) => x === shuffled[i]));
      const result = {};
      items.forEach((giver, i) => {
        result[giver] = shuffled[i];
      });
      return result;
    }

    function parseParticipants(text, includeOrganiserName) {
      const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
      const participants = [];
      lines.forEach(line => {
        const match = line.match(/^(.*)<(.*)>$/);
        if (match) {
          const name = match[1].trim();
          const email = match[2].trim();
          participants.push({ key: email, label: `${name} <${email}>` });
        } else {
          participants.push({ key: line, label: line });
        }
      });
      if (includeOrganiserName) {
        participants.push({
          key: includeOrganiserName,
          label: includeOrganiserName
        });
      }
      return participants;
    }

    // --- Actions ---
    async function createEvent() {
      const organiserName = document.getElementById("organiserName").value.trim();
      const organiserEmail = document.getElementById("organiserEmail").value.trim();
      const participantsText = document.getElementById("participants").value;
      const includeOrganiser = document.getElementById("includeOrganiser").checked;
      const msgEl = document.getElementById("setupMessage");

      msgEl.textContent = "";
      msgEl.className = "small";

      if (!organiserName || !organiserEmail) {
        msgEl.textContent = "Please provide organiser name and email.";
        msgEl.classList.add("error");
        return;
      }
      const parsedParticipants = parseParticipants(
        participantsText,
        includeOrganiser ? organiserEmail : null
      );
      if (parsedParticipants.length < 2) {
        msgEl.textContent = "You need at least 2 participants.";
        msgEl.classList.add("error");
        return;
      }

      const keys = parsedParticipants.map(p => p.key);
      const mapping = generateDerangement(keys);
      if (!mapping) {
        msgEl.textContent = "Could not generate valid pairs. Try different participants.";
        msgEl.classList.add("error");
        return;
      }

      const eventId = Math.random().toString(36).slice(2, 10);

      const participantsState = {};
      parsedParticipants.forEach(p => {
        participantsState[p.key] = {
          label: p.label,
          recipientKey: mapping[p.key],
          viewed: false,
          firstViewedAt: null,
          viewCount: 0
        };
      });

      const eventDoc = {
        organiserName,
        organiserEmail,
        createdAt: new Date().toISOString(),
        participants: participantsState
      };

      try {
        const createBtn = document.getElementById("createEventBtn");
        createBtn.disabled = true;
        createBtn.textContent = "Creating...";
        
        await setDoc(doc(db, "secret_santa_events", eventId), eventDoc);
        
        createBtn.disabled = false;
        createBtn.textContent = "üéÅ Create Event";

        const url = new URL(window.location.href);
        url.searchParams.set("event", eventId);
        const eventLink = url.toString();

        document.getElementById("share-card").classList.remove("hidden");
        document.getElementById("eventLink").textContent = eventLink;
        document.getElementById("adminEmailDisplay").textContent = organiserEmail;

        document.getElementById("eventIdInput").value = eventId;
        document.getElementById("adminEventIdInput").value = eventId;
        
        // Scroll to share card
        document.getElementById("share-card").scrollIntoView({behavior: 'smooth'});
        
      } catch (err) {
        console.error(err);
        msgEl.textContent = "Error: " + err.message;
        msgEl.classList.add("error");
        document.getElementById("createEventBtn").disabled = false;
        document.getElementById("createEventBtn").textContent = "Create Event";
      }
    }

    async function viewRecipient() {
      const eventId = document.getElementById("eventIdInput").value.trim();
      const participantKey = document.getElementById("participantKeyInput").value.trim();
      const resEl = document.getElementById("participantResult");

      resEl.textContent = "";
      resEl.className = "small";

      if (!eventId || !participantKey) {
        resEl.textContent = "Please provide Event ID and your name/email.";
        resEl.classList.add("error");
        return;
      }

      try {
        const docRef = doc(db, "secret_santa_events", eventId);
        const snap = await getDoc(docRef);
        if (!snap.exists()) {
          resEl.textContent = "Event not found.";
          resEl.classList.add("error");
          return;
        }
        const data = snap.data();
        const participants = data.participants || {};
        const participant = participants[participantKey];

        if (!participant) {
          resEl.textContent = "Name not found in this event. Check spelling!";
          resEl.classList.add("error");
          return;
        }

        const recipientKey = participant.recipientKey;
        const recipient = participants[recipientKey];
        const recipientLabel = recipient ? recipient.label : recipientKey;

        // Visual distinction for result
        resEl.innerHTML = `
          <div style="background:#e8f5e9; padding:1rem; border-radius:8px; border:1px solid #c8e6c9; margin-top:0.5rem;">
            Your recipient is:<br/>
            <strong style="font-size:1.3rem; color:#1b5e20;">${recipientLabel}</strong>
          </div>
        `;
        
        const newViewCount = (participant.viewCount || 0) + 1;
        const firstViewedAt = participant.firstViewedAt || new Date().toISOString();

        await updateDoc(docRef, {
          [`participants.${participantKey}.viewed`]: true,
          [`participants.${participantKey}.viewCount`]: newViewCount,
          [`participants.${participantKey}.firstViewedAt`]: firstViewedAt
        });
      } catch (err) {
        console.error(err);
        resEl.textContent = "Error: " + err.message;
        resEl.classList.add("error");
      }
    }

    async function loadAdminView() {
      const eventId = document.getElementById("adminEventIdInput").value.trim();
      const adminEmail = document.getElementById("adminEmailInput").value.trim();
      const msgEl = document.getElementById("adminMessage");
      const tableWrapper = document.getElementById("adminTableWrapper");
      const tbody = document.getElementById("adminTableBody");

      msgEl.textContent = "";
      msgEl.className = "small";
      tableWrapper.classList.add("hidden");
      tbody.innerHTML = "";

      if (!eventId || !adminEmail) {
        msgEl.textContent = "Enter Event ID and Organiser Email.";
        msgEl.classList.add("error");
        return;
      }

      try {
        const docRef = doc(db, "secret_santa_events", eventId);
        const snap = await getDoc(docRef);
        if (!snap.exists()) {
          msgEl.textContent = "Event not found.";
          msgEl.classList.add("error");
          return;
        }
        const data = snap.data();
        if (data.organiserEmail !== adminEmail) {
          msgEl.textContent = "Invalid email for this event.";
          msgEl.classList.add("error");
          return;
        }

        const participants = data.participants || {};
        const keys = Object.keys(participants).sort();

        keys.forEach(key => {
          const p = participants[key];
          const recipient = participants[p.recipientKey];
          const tr = document.createElement("tr");
          // Simple columns
          tr.innerHTML = `
            <td><strong>${p.label || key}</strong></td>
            <td>${recipient ? recipient.label : p.recipientKey}</td>
            <td>${p.viewed ? "<span style='color:green'>Yes</span>" : "<span style='color:#ccc'>No</span>"}</td>
          `;
          tbody.appendChild(tr);
        });

        tableWrapper.classList.remove("hidden");
        msgEl.textContent = "Stats loaded successfully.";
        msgEl.classList.add("success");
      } catch (err) {
        console.error(err);
        msgEl.textContent = "Error: " + err.message;
        msgEl.classList.add("error");
      }
    }

    // Attach listeners
    document.getElementById("createEventBtn").addEventListener("click", createEvent);
    document.getElementById("viewRecipientBtn").addEventListener("click", viewRecipient);
    document.getElementById("loadAdminBtn").addEventListener("click", loadAdminView);

    // Initial check for URL params
    const params = new URLSearchParams(window.location.search);
    const eventFromUrl = params.get("event");
    if (eventFromUrl) {
      document.getElementById("eventIdInput").value = eventFromUrl;
      document.getElementById("adminEventIdInput").value = eventFromUrl;
    }
  </script>
</body>
</html>