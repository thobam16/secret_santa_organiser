<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secret Santa Organiser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Optional: a slightly more playful font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
  :root {
    --xmas-red: #c62828;
    --xmas-red-dark: #8e0000;
    --xmas-green: #2e7d32;
    --xmas-green-dark: #1b5e20;
    --xmas-gold: #ffca28;
    --xmas-cream: #fff8e1;
    --bg-dark: #04131f;
  }

  * {
    box-sizing: border-box;
  }

  body {
    font-family: "Quicksand", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    max-width: 960px;
    margin: 0 auto;
    padding: 1.5rem;
    background:
      radial-gradient(circle at top left, rgba(255, 255, 255, 0.08), transparent 55%),
      radial-gradient(circle at top right, rgba(255, 255, 255, 0.06), transparent 55%),
      radial-gradient(circle at bottom, rgba(255, 255, 255, 0.05), transparent 55%),
      linear-gradient(160deg, #02111d, #062a34 40%, #0a1f3b);
    color: #fdfdfd;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
    /* Let snow flow all the way across */
  }

  /* --- SUPER HEAVY FALLING SNOW --- */
  body::before,
  body::after {
    content: "";
    pointer-events: none;
    position: fixed;
    top: -150%;
    left: -50%;
    width: 250%;
    height: 350%;
    z-index: -1;
  }

  /* Front, big & bright flakes */
  body::before {
    background-image:
      radial-gradient(4px 4px at 5% 10%, rgba(255,255,255,1) 50%, transparent 50%),
      radial-gradient(4px 4px at 15% 40%, rgba(255,255,255,0.95) 50%, transparent 50%),
      radial-gradient(4px 4px at 25% 80%, rgba(255,255,255,0.9) 50%, transparent 50%),
      radial-gradient(4px 4px at 35% 20%, rgba(255,255,255,1) 50%, transparent 50%),
      radial-gradient(4px 4px at 45% 60%, rgba(255,255,255,0.95) 50%, transparent 50%),
      radial-gradient(4px 4px at 55% 90%, rgba(255,255,255,1) 50%, transparent 50%),
      radial-gradient(4px 4px at 65% 30%, rgba(255,255,255,0.95) 50%, transparent 50%),
      radial-gradient(4px 4px at 75% 70%, rgba(255,255,255,1) 50%, transparent 50%),
      radial-gradient(4px 4px at 85% 50%, rgba(255,255,255,0.95) 50%, transparent 50%),
      radial-gradient(4px 4px at 95% 15%, rgba(255,255,255,1) 50%, transparent 50%),
      radial-gradient(3px 3px at 10% 90%, rgba(255,255,255,0.9) 50%, transparent 50%),
      radial-gradient(3px 3px at 30% 10%, rgba(255,255,255,0.9) 50%, transparent 50%),
      radial-gradient(3px 3px at 50% 40%, rgba(255,255,255,0.9) 50%, transparent 50%),
      radial-gradient(3px 3px at 70% 85%, rgba(255,255,255,0.9) 50%, transparent 50%),
      radial-gradient(3px 3px at 90% 35%, rgba(255,255,255,0.9) 50%, transparent 50%);
    opacity: 0.95;
    animation: snow-fall-heavy 16s linear infinite;
  }
  
  /* Back, dense field of smaller flakes */
  body::after {
    background-image:
      radial-gradient(2px 2px at 2% 5%, rgba(255,255,255,0.8) 50%, transparent 50%),
      radial-gradient(2px 2px at 8% 30%, rgba(255,255,255,0.75) 50%, transparent 50%),
      radial-gradient(2px 2px at 12% 70%, rgba(255,255,255,0.8) 50%, transparent 50%),
      radial-gradient(2px 2px at 18% 50%, rgba(255,255,255,0.7) 50%, transparent 50%),
      radial-gradient(2px 2px at 22% 15%, rgba(255,255,255,0.8) 50%, transparent 50%),
      radial-gradient(2px 2px at 28% 85%, rgba(255,255,255,0.75) 50%, transparent 50%),
      radial-gradient(2px 2px at 32% 40%, rgba(255,255,255,0.8) 50%, transparent 50%),
      radial-gradient(2px 2px at 38% 75%, rgba(255,255,255,0.7) 50%, transparent 50%),
      radial-gradient(2px 2px at 42% 20%, rgba(255,255,255,0.8) 50%, transparent 50%),
      radial-gradient(2px 2px at 48% 60%, rgba(255,255,255,0.7) 50%, transparent 50%),
      radial-gradient(2px 2px at 52% 90%, rgba(255,255,255,0.8) 50%, transparent 50%),
      radial-gradient(2px 2px at 58% 35%, rgba(255,255,255,0.75) 50%, transparent 50%),
      radial-gradient(2px 2px at 62% 10%, rgba(255,255,255,0.8) 50%, transparent 50%),
      radial-gradient(2px 2px at 68% 80%, rgba(255,255,255,0.75) 50%, transparent 50%),
      radial-gradient(2px 2px at 72% 55%, rgba(255,255,255,0.7) 50%, transparent 50%),
      radial-gradient(2px 2px at 78% 25%, rgba(255,255,255,0.8) 50%, transparent 50%),
      radial-gradient(2px 2px at 82% 65%, rgba(255,255,255,0.75) 50%, transparent 50%),
      radial-gradient(2px 2px at 88% 45%, rgba(255,255,255,0.8) 50%, transparent 50%),
      radial-gradient(2px 2px at 92% 75%, rgba(255,255,255,0.7) 50%, transparent 50%),
      radial-gradient(2px 2px at 96% 20%, rgba(255,255,255,0.8) 50%, transparent 50%);
    opacity: 0.85;
    animation: snow-fall-heavy 28s linear infinite;
  }
  
  /* Optional third layer: tiny slow flakes on <html> for extra depth */
  html::before {
    content: "";
    pointer-events: none;
    position: fixed;
    top: -150%;
    left: -50%;
    width: 250%;
    height: 350%;
    z-index: -2;
    background-image:
      radial-gradient(1.5px 1.5px at 10% 10%, rgba(255,255,255,0.5) 50%, transparent 50%),
      radial-gradient(1.5px 1.5px at 20% 50%, rgba(255,255,255,0.5) 50%, transparent 50%),
      radial-gradient(1.5px 1.5px at 30% 80%, rgba(255,255,255,0.5) 50%, transparent 50%),
      radial-gradient(1.5px 1.5px at 40% 30%, rgba(255,255,255,0.5) 50%, transparent 50%),
      radial-gradient(1.5px 1.5px at 50% 60%, rgba(255,255,255,0.5) 50%, transparent 50%),
      radial-gradient(1.5px 1.5px at 60% 15%, rgba(255,255,255,0.5) 50%, transparent 50%),
      radial-gradient(1.5px 1.5px at 70% 45%, rgba(255,255,255,0.5) 50%, transparent 50%),
      radial-gradient(1.5px 1.5px at 80% 75%, rgba(255,255,255,0.5) 50%, transparent 50%),
      radial-gradient(1.5px 1.5px at 90% 25%, rgba(255,255,255,0.5) 50%, transparent 50%);
    opacity: 0.5;
    animation: snow-fall-heavy 40s linear infinite;
  }
  
  /* Heavier, slightly drifting fall */
  @keyframes snow-fall-heavy {
    0% {
      transform: translate3d(0, 0, 0);
    }
    50% {
      transform: translate3d(-5%, 25%, 0);
    }
    100% {
      transform: translate3d(5%, 55%, 0);
    }
  }


  h1, h2, h3 {
    text-align: center;
    margin-top: 0;
    margin-bottom: 0.75rem;
  }

  h1 {
    font-size: 2.3rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--xmas-gold);
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  h1::before,
  h1::after {
    content: "üéÑ";
    font-size: 1.5rem;
  }

  h2 {
    color: var(--xmas-red);
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
  }

  h3 {
    color: var(--xmas-green);
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
  }

  .card {
    background: radial-gradient(circle at top, var(--xmas-cream), #ffe0b2);
    border-radius: 16px;
    padding: 1.25rem 1.5rem 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow:
      0 18px 40px rgba(0, 0, 0, 0.35),
      0 0 0 2px rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.7);
    position: relative;
    overflow: hidden;
    color: #333;
  }

  .card::before {
    content: "";
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(135deg, rgba(198, 40, 40, 0.08) 25%, transparent 25%, transparent 50%, rgba(198, 40, 40, 0.08) 50%, rgba(198, 40, 40, 0.08) 75%, transparent 75%, transparent);
    background-size: 22px 22px;
    opacity: 0.25;
    pointer-events: none;
    mix-blend-mode: soft-light;
  }

  .card > * {
    position: relative;
    z-index: 1;
  }

  .card:nth-of-type(odd) {
    border-image: linear-gradient(135deg, var(--xmas-red), var(--xmas-green)) 1;
  }

  label {
    display: block;
    margin-top: 0.75rem;
    font-weight: 600;
    color: #4a2b10;
  }

  /* --- FIX CHECKBOX ALIGNMENT --- */
  .row label {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    margin-top: 0.25rem;
  }

  input[type="checkbox"] {
    width: auto;
    margin: 0;
    flex-shrink: 0;
  }
  /* --- end checkbox tweak --- */

  input, textarea, button {
    font: inherit;
  }

  input:not([type="checkbox"]), textarea {
    width: 100%;
    padding: 0.6rem 0.7rem;
    margin-top: 0.25rem;
    border-radius: 999px;
    border: 2px solid rgba(0, 0, 0, 0.08);
    box-sizing: border-box;
    background: rgba(255, 255, 255, 0.9);
    outline: none;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }

  textarea {
    min-height: 120px;
    resize: vertical;
    border-radius: 14px;
  }

  input:not([type="checkbox"]):focus,
  textarea:focus {
    border-color: var(--xmas-green);
    box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.25);
    background: #ffffff;
  }

  button {
    margin-top: 1rem;
    padding: 0.65rem 1.4rem;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-weight: 700;
    background: linear-gradient(135deg, var(--xmas-green), var(--xmas-green-dark));
    color: white;
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.85rem;
    transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
  }

  button::before {
    content: "üéÅ";
    font-size: 1rem;
  }

  button.secondary {
    background: linear-gradient(135deg, var(--xmas-red), var(--xmas-red-dark));
  }

  button:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 10px 18px rgba(0, 0, 0, 0.4);
    filter: brightness(1.03);
  }

  button:active:not(:disabled) {
    transform: translateY(0);
    box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3) inset;
  }

  button:disabled {
    opacity: 0.65;
    cursor: not-allowed;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2) inset;
    filter: grayscale(0.2);
  }

  .hidden {
    display: none;
  }

  .small {
    font-size: 0.9rem;
    color: #5a452a;
  }

  .error {
    color: #b00020;
    margin-top: 0.5rem;
    font-weight: 600;
  }

  .success {
    color: var(--xmas-green-dark);
    margin-top: 0.5rem;
    font-weight: 600;
  }

  .row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
  }

  .row > div {
    flex: 1 1 250px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
    border-radius: 12px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.9);
  }

  th, td {
    border: 1px solid rgba(0, 0, 0, 0.06);
    padding: 0.45rem 0.5rem;
    text-align: left;
    font-size: 0.88rem;
  }

  th {
    background: linear-gradient(135deg, var(--xmas-red), var(--xmas-green));
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.75rem;
  }

  tr:nth-child(even) td {
    background: rgba(0, 0, 0, 0.02);
  }

  code {
    background: rgba(0, 0, 0, 0.08);
    padding: 0.12rem 0.35rem;
    border-radius: 4px;
    font-size: 0.9rem;
    font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    color: #2e2e2e;
  }

  .card h2 + p.small::before {
    content: "‚õÑ ";
  }

  .card h2 + p.small::after {
    content: " üéÖ";
  }

  @media (max-width: 600px) {
    body {
      padding: 1rem 0.75rem 1.5rem;
    }

    h1 {
      font-size: 1.85rem;
    }

    .card {
      padding: 1rem 1.1rem 1.25rem;
    }
  }
  </style>

</head>
<body>
  <h1>Secret Santa Organiser</h1>

  <!-- Setup Panel (organiser) -->
  <div id="setup-card" class="card">
    <h2>1. Create a new Secret Santa event</h2>
    <p class="small">
      Fill this in once as the organiser. You can participate as well ‚Äì the elves approve. üéÖ
    </p>
    <label for="organiserName">Organiser name</label>
    <input id="organiserName" type="text" placeholder="e.g. Alice" />

    <label for="organiserEmail">Organiser email (for admin access)</label>
    <input id="organiserEmail" type="email" placeholder="e.g. alice@example.com" />

    <label for="participants">
      Participants (one per line, use a simple format like <code>Name &lt;email&gt;</code> or just a unique name)
    </label>
    <textarea id="participants" placeholder="Alice &lt;alice@example.com&gt;
Bob &lt;bob@example.com&gt;
Charlie &lt;charlie@example.com&gt;"></textarea>

    <div class="row">
      <div>
        <label>
          <input type="checkbox" id="includeOrganiser" />
          Include organiser as a participant
        </label>
      </div>
    </div>

    <button id="createEventBtn">Create Secret Santa</button>
    <div id="setupMessage" class="small"></div>
  </div>

  <!-- Share Details -->
  <div id="share-card" class="card hidden">
    <h2>2. Share with participants</h2>
    <p class="small">
      Send this link to everyone taking part. They‚Äôll use their name/email to find their lucky recipient.
    </p>
    <p>
      Event link: <code id="eventLink"></code>
    </p>
    <p class="small">
      Admin email: <code id="adminEmailDisplay"></code> (use this below to view stats)
    </p>
  </div>

  <!-- Participant View -->
  <div id="participant-card" class="card">
    <h2>Participant: see your recipient</h2>
    <p class="small">
      If you're a participant, enter your name/email exactly as the organiser used for you ‚Äì no peeking at others‚Äô gifts! üéÅ
    </p>

    <label for="eventIdInput">Event ID</label>
    <input id="eventIdInput" type="text" placeholder="Event ID from link (auto-filled if you used the link)" />

    <label for="participantKeyInput">Your name/email</label>
    <input id="participantKeyInput" type="text" placeholder="e.g. alice@example.com or Alice" />

    <button id="viewRecipientBtn">View my recipient</button>

    <div id="participantResult" class="small"></div>
  </div>

  <!-- Admin / Organiser Dashboard -->
  <div id="admin-card" class="card">
    <h2>Organiser dashboard</h2>
    <p class="small">
      See who has already viewed their recipient. Use the same organiser email as in setup ‚Äì Santa needs to keep track. üßù
    </p>

    <label for="adminEventIdInput">Event ID</label>
    <input id="adminEventIdInput" type="text" placeholder="Event ID" />

    <label for="adminEmailInput">Organiser email</label>
    <input id="adminEmailInput" type="email" placeholder="Organiser email" />

    <button id="loadAdminBtn">Load event stats</button>
    <div id="adminMessage" class="small"></div>
    <div id="adminTableWrapper" class="hidden">
      <h3>Participants &amp; views</h3>
      <table>
        <thead>
          <tr>
            <th>Participant</th>
            <th>Recipient</th>
            <th>Viewed?</th>
            <th>First viewed at</th>
            <th>Times viewed</th>
          </tr>
        </thead>
        <tbody id="adminTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    // TODO: replace this config with your own Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAdevrXnZ-rfHNxXHHh-R9_aDEKzqeU1mQ",
      authDomain: "secret-santa-organiser.firebaseapp.com",
      projectId: "secret-santa-organiser",
      storageBucket: "secret-santa-organiser.firebasestorage.app",
      messagingSenderId: "851546467900",
      appId: "1:851546467900:web:e81ee0bc4d6790bffa9d39",
      measurementId: "G-ZBJW29F5PJ"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function shuffle(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function generateDerangement(items) {
      if (items.length < 2) return null;
      let shuffled;
      let attempts = 0;
      do {
        shuffled = shuffle(items);
        attempts++;
        if (attempts > 1000) return null;
      } while (items.some((x, i) => x === shuffled[i]));
      const result = {};
      items.forEach((giver, i) => {
        result[giver] = shuffled[i];
      });
      return result;
    }

    function parseParticipants(text, includeOrganiserName) {
      const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
      const participants = [];
      lines.forEach(line => {
        const match = line.match(/^(.*)<(.*)>$/);
        if (match) {
          const name = match[1].trim();
          const email = match[2].trim();
          participants.push({ key: email, label: `${name} <${email}>` });
        } else {
          participants.push({ key: line, label: line });
        }
      });
      if (includeOrganiserName) {
        participants.push({
          key: includeOrganiserName,
          label: includeOrganiserName
        });
      }
      return participants;
    }

    async function createEvent() {
      const organiserName = document.getElementById("organiserName").value.trim();
      const organiserEmail = document.getElementById("organiserEmail").value.trim();
      const participantsText = document.getElementById("participants").value;
      const includeOrganiser = document.getElementById("includeOrganiser").checked;
      const msgEl = document.getElementById("setupMessage");

      msgEl.textContent = "";
      msgEl.className = "small";

      if (!organiserName || !organiserEmail) {
        msgEl.textContent = "Please provide organiser name and email.";
        msgEl.classList.add("error");
        return;
      }
      const parsedParticipants = parseParticipants(
        participantsText,
        includeOrganiser ? organiserEmail : null
      );
      if (parsedParticipants.length < 2) {
        msgEl.textContent = "You need at least 2 participants.";
        msgEl.classList.add("error");
        return;
      }

      const keys = parsedParticipants.map(p => p.key);
      const mapping = generateDerangement(keys);
      if (!mapping) {
        msgEl.textContent = "Could not generate a valid assignment, try different participants.";
        msgEl.classList.add("error");
        return;
      }

      const eventId = Math.random().toString(36).slice(2, 10);

      const participantsState = {};
      parsedParticipants.forEach(p => {
        participantsState[p.key] = {
          label: p.label,
          recipientKey: mapping[p.key],
          viewed: false,
          firstViewedAt: null,
          viewCount: 0
        };
      });

      const eventDoc = {
        organiserName,
        organiserEmail,
        createdAt: new Date().toISOString(),
        participants: participantsState
      };

      try {
        const createBtn = document.getElementById("createEventBtn");
        createBtn.disabled = true;
        createBtn.textContent = "Creating...";
        await setDoc(doc(db, "secret_santa_events", eventId), eventDoc);
        createBtn.disabled = false;
        createBtn.textContent = "Create Secret Santa";

        msgEl.textContent = `Event created! Event ID: ${eventId}`;
        msgEl.classList.add("success");

        const url = new URL(window.location.href);
        url.searchParams.set("event", eventId);
        const eventLink = url.toString();

        document.getElementById("share-card").classList.remove("hidden");
        document.getElementById("eventLink").textContent = eventLink;
        document.getElementById("adminEmailDisplay").textContent = organiserEmail;

        document.getElementById("eventIdInput").value = eventId;
        document.getElementById("adminEventIdInput").value = eventId;
      } catch (err) {
        console.error(err);
        msgEl.textContent = "Error creating event: " + err.message;
        msgEl.classList.add("error");
        document.getElementById("createEventBtn").disabled = false;
        document.getElementById("createEventBtn").textContent = "Create Secret Santa";
      }
    }

    async function viewRecipient() {
      const eventId = document.getElementById("eventIdInput").value.trim();
      const participantKey = document.getElementById("participantKeyInput").value.trim();
      const resEl = document.getElementById("participantResult");

      resEl.textContent = "";
      resEl.className = "small";

      if (!eventId || !participantKey) {
        resEl.textContent = "Please provide event ID and your name/email.";
        resEl.classList.add("error");
        return;
      }

      try {
        const docRef = doc(db, "secret_santa_events", eventId);
        const snap = await getDoc(docRef);
        if (!snap.exists()) {
          resEl.textContent = "No event found with that ID.";
          resEl.classList.add("error");
          return;
        }
        const data = snap.data();
        const participants = data.participants || {};
        const participant = participants[participantKey];

        if (!participant) {
          resEl.textContent = "No participant found with that name/email. Check with the organiser.";
          resEl.classList.add("error");
          return;
        }

        const recipientKey = participant.recipientKey;
        const recipient = participants[recipientKey];
        const recipientLabel = recipient ? recipient.label : recipientKey;

        resEl.innerHTML = `
          <strong>Your recipient:</strong><br/>
          ${recipientLabel}
        `;
        resEl.classList.add("success");

        const newViewCount = (participant.viewCount || 0) + 1;
        const firstViewedAt = participant.firstViewedAt || new Date().toISOString();

        await updateDoc(docRef, {
          [`participants.${participantKey}.viewed`]: true,
          [`participants.${participantKey}.viewCount`]: newViewCount,
          [`participants.${participantKey}.firstViewedAt`]: firstViewedAt
        });
      } catch (err) {
        console.error(err);
        resEl.textContent = "Error loading recipient: " + err.message;
        resEl.classList.add("error");
      }
    }

    async function loadAdminView() {
      const eventId = document.getElementById("adminEventIdInput").value.trim();
      const adminEmail = document.getElementById("adminEmailInput").value.trim();
      const msgEl = document.getElementById("adminMessage");
      const tableWrapper = document.getElementById("adminTableWrapper");
      const tbody = document.getElementById("adminTableBody");

      msgEl.textContent = "";
      msgEl.className = "small";
      tableWrapper.classList.add("hidden");
      tbody.innerHTML = "";

      if (!eventId || !adminEmail) {
        msgEl.textContent = "Please provide event ID and organiser email.";
        msgEl.classList.add("error");
        return;
      }

      try {
        const docRef = doc(db, "secret_santa_events", eventId);
        const snap = await getDoc(docRef);
        if (!snap.exists()) {
          msgEl.textContent = "No event found with that ID.";
          msgEl.classList.add("error");
          return;
        }
        const data = snap.data();
        if (data.organiserEmail !== adminEmail) {
          msgEl.textContent = "Organiser email does not match. Access denied.";
          msgEl.classList.add("error");
          return;
        }

        const participants = data.participants || {};
        const keys = Object.keys(participants).sort();

        keys.forEach(key => {
          const p = participants[key];
          const recipient = participants[p.recipientKey];
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.label || key}</td>
            <td>${recipient ? recipient.label : p.recipientKey}</td>
            <td>${p.viewed ? "‚úÖ" : "‚ùå"}</td>
            <td>${p.firstViewedAt ? new Date(p.firstViewedAt).toLocaleString() : "-"}</td>
            <td>${p.viewCount || 0}</td>
          `;
          tbody.appendChild(tr);
        });

        tableWrapper.classList.remove("hidden");
        msgEl.textContent = `Loaded ${keys.length} participants.`;
        msgEl.classList.add("success");
      } catch (err) {
        console.error(err);
        msgEl.textContent = "Error loading admin view: " + err.message;
        msgEl.classList.add("error");
      }
    }

    document.getElementById("createEventBtn").addEventListener("click", createEvent);
    document.getElementById("viewRecipientBtn").addEventListener("click", viewRecipient);
    document.getElementById("loadAdminBtn").addEventListener("click", loadAdminView);

    const params = new URLSearchParams(window.location.search);
    const eventFromUrl = params.get("event");
    if (eventFromUrl) {
      document.getElementById("eventIdInput").value = eventFromUrl;
      document.getElementById("adminEventIdInput").value = eventFromUrl;
    }
  </script>
</body>
</html>
